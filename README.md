# Парсер участников беседы ВКонтакте и построение графа отношений

Этот скрипт позволяет:
- Получить список всех участников беседы ВКонтакте
- Собрать открытую информацию о каждом участнике
- Сохранить данные в CSV файл
- Построить граф отношений между участниками по их друзьям
- Визуализировать граф отношений и сохранить его в виде изображения
- Экспортировать граф в формате Gephi для дальнейшего анализа

## Требования

Для работы скрипта необходимы следующие библиотеки:
- vk_api
- pandas
- networkx
- matplotlib

Установка:
```
pip install vk_api pandas networkx matplotlib
```

## Использование

### Базовое использование

```
python main.py
```

### Процесс работы

1. Авторизация:
   - При первом запуске потребуется ввести логин и пароль от ВК
   - Если включена двухфакторная аутентификация, скрипт запросит код подтверждения
   - После успешной авторизации токен сохраняется в файл `vk_token.txt` и будет использован при следующих запусках
   - Если токен устареет, скрипт автоматически предложит авторизоваться заново
   - Также можно передать токен через параметр `--token`

2. Указание ID беседы:
   - ID беседы можно указать через параметр `--chat-id`
   - Или ввести вручную при запросе
   - ID беседы можно узнать из URL-адреса беседы в веб-версии ВК: `https://vk.com/im?sel=c{ID}`
   - Например, для URL `https://vk.com/im?sel=c12` ID беседы будет `12`
   - После первого ввода ID беседы сохраняется в файл `chat_id.txt` и будет предложен при следующих запусках

3. Сбор данных:
   - Скрипт автоматически сохраняет промежуточные результаты каждые 5 пользователей в папку `temp/`
   - При повторном запуске скрипт проверит наличие сохраненных данных и предложит использовать их
   - В случае прерывания работы скрипта (ошибка или прерывание пользователем) данные будут сохранены
   - При следующем запуске можно продолжить работу с места остановки

4. Результаты:
   - `vk_chat_members.csv` (или имя, указанное в параметре `--output`) - данные об участниках беседы
   - `vk_chat_connections.csv` - данные о связях между участниками
   - `vk_relationship_graph.png` - визуализация графа отношений
   - `vk_relationship_graph.gexf` - граф в формате Gephi для углубленного анализа


## Примечание

- Для корректной работы скрипта необходим доступ к API ВКонтакте, который предоставляется через авторизацию
- Скрипт работает только с теми данными пользователей, которые доступны публично или для авторизованного аккаунта
- Обратите внимание, что частые запросы к API ВК могут привести к временным ограничениям. В скрипте установлена небольшая задержка между запросами.
- Если у вас возникают проблемы с авторизацией, удалите файл `vk_token.txt` и запустите скрипт заново
- Для полного сброса промежуточных данных удалите папку `temp/` 


# Подробное объяснение работы каждой функции в скрипте для парсинга данных ВКонтакте

## 1. `auth_vk(token: Optional[str] = None)`

Эта функция отвечает за авторизацию в API ВКонтакте.

**Входные данные:**
- `token` (опционально) - строка с токеном доступа

**Процесс работы:**
1. Сначала функция проверяет, был ли передан токен в аргументах
2. Если токен передан, пытается авторизоваться с его помощью
3. Если не удалось или токен не был передан, проверяет наличие сохраненного токена в файле "vk_token.txt"
4. Если и это не удалось, запрашивает логин и пароль у пользователя
5. При вводе логина и пароля также обрабатывает двухфакторную аутентификацию через функцию `two_factor()`
6. В случае ошибки авторизации через логин/пароль, предлагает ввести токен вручную
7. После успешной авторизации сохраняет токен в файл для последующего использования

**Возвращаемое значение:**
- Объект API-клиента ВКонтакте (`vk_api.vk_api.VkApiMethod`) при успешной авторизации
- `None` в случае ошибки авторизации

## 2. `get_chat_members(vk, chat_id: int)`

Функция для получения списка участников беседы ВКонтакте.

**Входные данные:**
- `vk` - объект API-клиента ВКонтакте
- `chat_id` - числовой идентификатор беседы

**Процесс работы:**
1. Формирует запрос к API ВКонтакте, преобразуя ID беседы в соответствующий формат peer_id (добавляет 2000000000)
2. Вызывает метод `messages.getConversationMembers`
3. В случае ошибки выводит информативное сообщение с возможными причинами

**Возвращаемое значение:**
- Список словарей с информацией об участниках беседы
- Пустой список в случае ошибки

## 3. `get_user_info(vk, user_id: int)`

Функция для получения подробной информации о конкретном пользователе.

**Входные данные:**
- `vk` - объект API-клиента ВКонтакте
- `user_id` - числовой идентификатор пользователя

**Процесс работы:**
1. Делает запрос к методу `users.get` с указанным набором полей
2. Запрашивает информацию о городе, дате рождения, поле, образовании, количестве подписчиков и т.д.
3. Обрабатывает возможные ошибки при получении данных

**Возвращаемое значение:**
- Словарь с информацией о пользователе
- `None` в случае ошибки

## 4. `get_user_friends(vk, user_id: int)`

Функция для получения списка друзей пользователя.

**Входные данные:**
- `vk` - объект API-клиента ВКонтакте
- `user_id` - числовой идентификатор пользователя

**Процесс работы:**
1. Делает запрос к методу `friends.get`
2. Получает список идентификаторов всех друзей указанного пользователя
3. Обрабатывает возможные ошибки (например, если профиль закрыт)

**Возвращаемое значение:**
- Список числовых идентификаторов друзей пользователя
- Пустой список в случае ошибки

## 5. `save_to_csv(data, filename: str)`

Функция для сохранения информации о пользователях в CSV-файл.

**Входные данные:**
- `data` - список словарей с информацией о пользователях
- `filename` - имя файла для сохранения (по умолчанию "vk_chat_members.csv")

**Процесс работы:**
1. Проверяет наличие данных для сохранения
2. Определяет поля для CSV-файла (id, имя, фамилия, пол и т.д.)
3. Создает CSV-файл и записывает заголовок
4. Для каждого пользователя формирует словарь с нужными данными
5. Записывает данные пользователей в CSV-формате

**Возвращаемое значение:**
- Функция ничего не возвращает, но выводит сообщение об успешном сохранении

## 6. `save_intermediate_data(users_data, friends_data, prefix: str)`

Функция для сохранения промежуточных результатов сбора данных в JSON-файлы.

**Входные данные:**
- `users_data` - список словарей с данными о пользователях
- `friends_data` - словарь, где ключи - ID пользователей, значения - списки ID друзей
- `prefix` - префикс для имен файлов (по умолчанию "intermediate")

**Процесс работы:**
1. Создает директорию "temp", если она не существует
2. Сохраняет данные о пользователях в JSON-файл
3. Преобразует ключи словаря friends_data из int в str (для корректного сохранения в JSON)
4. Сохраняет данные о друзьях в отдельный JSON-файл

**Возвращаемое значение:**
- Функция ничего не возвращает, но выводит сообщение о сохранении данных

## 7. `load_intermediate_data(prefix: str)`

Функция для загрузки промежуточных результатов из JSON-файлов.

**Входные данные:**
- `prefix` - префикс имен файлов (по умолчанию "intermediate")

**Процесс работы:**
1. Проверяет наличие файлов с данными в директории "temp"
2. Загружает данные о пользователях из первого файла
3. Загружает данные о друзьях из второго файла
4. Преобразует ключи словаря из str обратно в int
5. Обрабатывает возможные ошибки при загрузке файлов

**Возвращаемое значение:**
- Кортеж из двух элементов: список данных о пользователях и словарь с данными о друзьях
- Если файлов нет или произошла ошибка, возвращает пустые структуры данных

## 8. `save_connections_csv(users_data, friends_data)`

Функция для сохранения данных о связях между пользователями в простом формате CSV.

**Входные данные:**
- `users_data` - список словарей с данными о пользователях
- `friends_data` - словарь со списками друзей для каждого пользователя

**Процесс работы:**
1. Создает множество ID всех пользователей беседы для быстрого поиска
2. Открывает CSV-файл и записывает заголовок
3. Для каждого пользователя находит его друзей среди участников беседы
4. Записывает каждую найденную связь в формате "ID_источника, ID_цели"
5. Чтобы избежать дублирования связей, записывает их только в одном направлении (user_id < friend_id)

**Возвращаемое значение:**
- Функция ничего не возвращает, но выводит сообщение об успешном сохранении

## 9. `save_extended_connections(users_data, friends_data)`

Функция для сохранения расширенных данных о связях, включая имена пользователей.

**Входные данные:**
- `users_data` - список словарей с данными о пользователях
- `friends_data` - словарь со списками друзей для каждого пользователя

**Процесс работы:**
1. Создает словарь для быстрого доступа к данным пользователей по ID
2. Получает множество всех ID пользователей беседы
3. Открывает CSV-файл и записывает расширенный заголовок
4. Для каждого пользователя находит его друзей среди участников беседы
5. Записывает каждую связь с полной информацией: ID, имя и фамилия источника и цели, тип связи
6. Проверяет наличие пользователей в словаре users_dict для избежания ошибок

**Возвращаемое значение:**
- Функция ничего не возвращает, но выводит сообщение об успешном сохранении

## 10. `save_connections_stats(users_data, friends_data)`

Функция для сохранения статистики по связям каждого пользователя.

**Входные данные:**
- `users_data` - список словарей с данными о пользователях
- `friends_data` - словарь со списками друзей для каждого пользователя

**Процесс работы:**
1. Получает множество всех ID пользователей беседы
2. Открывает CSV-файл и записывает заголовок
3. Для каждого пользователя из беседы:
   - Получает список его друзей (пустой список, если данных нет)
   - Вычисляет количество его друзей, которые также находятся в беседе
   - Вычисляет общее количество друзей
   - Рассчитывает долю друзей из беседы среди всех друзей
4. Записывает статистику в CSV-файл

**Возвращаемое значение:**
- Функция ничего не возвращает, но выводит сообщение об успешном сохранении

## 11. `collect_users_data(vk, chat_id: int)`

Основная функция для сбора данных о пользователях и их друзьях.

**Входные данные:**
- `vk` - объект API-клиента ВКонтакте
- `chat_id` - числовой идентификатор беседы

**Процесс работы:**
1. Инициализирует пустые структуры данных для хранения результатов
2. Получает список участников беседы через функцию `get_chat_members`
3. Если участники не найдены, завершает работу
4. В цикле для каждого участника:
   - Проверяет, что ID пользователя положительный (не группа)
   - Получает информацию о пользователе через `get_user_info`
   - Получает список друзей пользователя через `get_user_friends`
   - Каждые 5 пользователей сохраняет промежуточные результаты
   - Делает паузу между запросами, чтобы избежать блокировки API
5. Обрабатывает возможные прерывания (пользователем или ошибкой)

**Возвращаемое значение:**
- Кортеж из двух элементов: список данных о пользователях и словарь с данными о друзьях

## 12. `get_chat_id()`

Функция для получения ID беседы от пользователя или из сохраненного файла.

**Входные данные:**
- Функция не принимает аргументов

**Процесс работы:**
1. Проверяет наличие файла "chat_id.txt" с сохраненным ID беседы
2. Если файл существует, спрашивает пользователя, использовать ли сохраненный ID
3. Если пользователь соглашается, возвращает сохраненный ID
4. В противном случае, запрашивает новый ID у пользователя
5. Сохраняет новый ID в файл для последующего использования

**Возвращаемое значение:**
- Числовой идентификатор беседы (int)

## 13. `main()`

Главная функция программы, координирующая работу всех остальных функций.

**Процесс работы:**
1. Выполняет авторизацию через функцию `auth_vk`
2. В случае неудачной авторизации завершает работу
3. Получает ID беседы через функцию `get_chat_id`
4. Проверяет наличие сохраненных промежуточных данных через `load_intermediate_data`
5. Если данные найдены, спрашивает пользователя, использовать их или собрать заново
6. Если данных нет или пользователь выбрал сбор заново, вызывает `collect_users_data`
7. Проверяет, что собранные данные не пусты
8. Если данные успешно собраны, сохраняет их в различные CSV-файлы:
   - Информация о пользователях
   - Данные о связях
   - Расширенные данные о связях
   - Статистика по связям

**Возвращаемое значение:**
- Функция ничего не возвращает

## Заключение

Каждая функция в скрипте выполняет конкретную задачу в общем процессе сбора и обработки данных из ВКонтакте. Функции спроектированы таким образом, чтобы:

1. Обеспечить модульность и переиспользуемость кода
2. Обрабатывать возможные ошибки и сбои
3. Сохранять промежуточные результаты для предотвращения потери данных
4. Представлять результаты в удобном для дальнейшего анализа формате (CSV)

Скрипт эффективно собирает данные об участниках беседы ВКонтакте и их взаимосвязях, оптимизируя количество запросов к API и обеспечивая возможность продолжить работу в случае прерывания процесса.
